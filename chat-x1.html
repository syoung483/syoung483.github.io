<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸèƒ½ä¸‰ - æ˜Ÿç« X1 å¯¹è¯æ¨¡å‹</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .chat-container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .chat-card { background: #ffffff; border-radius: 16px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); border: 1px solid #e9ecef; }
        .msg-list { max-height: 60vh; overflow: auto; padding: 8px; }
        .msg { display:flex; flex-direction: column; gap: 6px; margin: 12px 0; }
        .bubble { max-width: 80%; padding: 12px 14px; border-radius: 14px; line-height: 1.7; word-break: break-word; white-space: pre-wrap; }
        .user { align-items: flex-end; }
        .user .bubble { background: #e8f3ff; border: 1px solid #cfe2ff; border-bottom-right-radius: 4px; }
        .assistant { align-items: flex-start; }
        .assistant .bubble { background: #f8f9fa; border: 1px solid #e9ecef; border-bottom-left-radius: 4px; }
        .reasoning { max-width: 80%; font-size: 13px; color: #6c757d; background: #fff; border-left: 3px solid #17a2b8; padding: 6px 10px; border-radius: 6px; }
        .input-row { display: flex; gap: 10px; margin-top: 12px; }
        .input-row input { flex: 1; padding: 12px 14px; border-radius: 24px; border: 1px solid #ced4da; outline: none; }
        .btn { padding: 10px 16px; border: none; border-radius: 20px; cursor: pointer; color: white; background: #28a745; }
        .btn:disabled { background: #6c757d; cursor: not-allowed; }
        .top-actions { display:flex; gap:10px; align-items:center; margin-bottom:12px; }
        .small { font-size: 12px; color:#6c757d; }
    </style>
</head>
<body>
<div id="container">
    <div class="chat-container">
        <button class="back-btn" onclick="window.location.href='home.html'">â† è¿”å›é¦–é¡µ</button>
        <h1>ğŸ¤– æ˜Ÿç« X1 å¯¹è¯æ¨¡å‹</h1>
        <p class="subtitle">åŸºäº WebSocket çš„æµå¼å¯¹è¯ Demoï¼ˆåŠŸèƒ½ä¸‰ï¼‰</p>

        <div class="chat-card">
            <div class="top-actions">
                <button class="btn" id="connectBtn" onclick="ensureConnected()">è¿æ¥æ¨¡å‹</button>
                <span id="statusText" class="small">æœªè¿æ¥</span>
            </div>
            <div id="msgList" class="msg-list"></div>
            <div class="input-row">
                <input id="userInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œå¦‚ï¼šæ¨èä¸¤ä¸ªé€‚åˆè‡ªé©¾æ˜¥æ¸¸çš„æ™¯ç‚¹" />
                <button class="btn" id="sendBtn" onclick="sendMsg()" disabled>å‘é€</button>
            </div>
            <div class="small" style="margin-top:8px;">æç¤ºï¼šå·²æ”¯æŒè‡ªåŠ¨è¿æ¥ä¸é‡è¿ã€‚ç›´æ¥è¾“å…¥é—®é¢˜å¹¶å‘é€å³å¯ã€‚</div>
        </div>
    </div>
</div>

<script>
let ws = null;
let appId = '';
let connected = false;
let connecting = false;
let pendingToSend = null; // ç­‰å¾…è¿æ¥åå‘é€çš„æ¶ˆæ¯
let currentAssistantEl = null; // å½“å‰èšåˆæ˜¾ç¤ºçš„AIç­”æ¡ˆå…ƒç´ ï¼ˆæ°”æ³¡ï¼‰
let currentReasoningEl = null; // å½“å‰æ¨ç†å†…å®¹å…ƒç´ ï¼ˆä½äºç­”æ¡ˆä¸Šæ–¹ï¼‰

function createMsg(role, text){
    const list = document.getElementById('msgList');
    const line = document.createElement('div');
    line.className = `msg ${role}`;
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text || '';
    line.appendChild(bubble);
    list.appendChild(line);
    list.scrollTop = list.scrollHeight;
    return bubble;
}

function appendUser(text){
    createMsg('user', text);
}

function beginAssistant(){
    currentAssistantEl = createMsg('assistant', '');
    currentReasoningEl = null;
}

function appendAssistantChunk(content){
    if (!currentAssistantEl) beginAssistant();
    currentAssistantEl.textContent += content;
    const list = document.getElementById('msgList');
    list.scrollTop = list.scrollHeight;
}

function appendReasoningChunk(content){
    if (!currentAssistantEl) beginAssistant();
    if (!currentReasoningEl){
        currentReasoningEl = document.createElement('div');
        currentReasoningEl.className = 'reasoning';
        currentReasoningEl.textContent = '';
        // æ¨ç†æ”¾åœ¨ç­”æ¡ˆä¸Šæ–¹ï¼šæ’å…¥åˆ°æ°”æ³¡ä¹‹å‰
        const parent = currentAssistantEl.parentElement;
        parent.insertBefore(currentReasoningEl, currentAssistantEl);
    }
    currentReasoningEl.textContent += content;
}

async function ensureConnected(){
    if (connected || connecting) return;
    setStatus('æ­£åœ¨è·å–ç­¾å...');
    connecting = true;
    try {
        const resp = await fetch('/api/spark-x1/sign');
        const data = await resp.json();
        if (!data.success) throw new Error(data.message || 'ç­¾åå¤±è´¥');
        const url = data.url; appId = data.appId;
        setStatus('æ­£åœ¨å»ºç«‹è¿æ¥...');
        ws = new WebSocket(url);
        ws.onopen = () => {
            connected = true; connecting = false;
            setStatus('å·²è¿æ¥');
            document.getElementById('sendBtn').disabled = false;
            if (pendingToSend){ const tmp = pendingToSend; pendingToSend = null; _send(tmp); }
        };
        ws.onmessage = (event) => {
            try {
                const payload = JSON.parse(event.data);
                if (payload?.header?.code && payload.header.code !== 0) { setStatus('é”™è¯¯: ' + payload.header.message); return; }
                const choices = payload?.payload?.choices;
                if (choices?.text && choices.text.length > 0) {
                    const item = choices.text[0];
                    if (item.reasoning_content) appendReasoningChunk(item.reasoning_content);
                    if (item.content) appendAssistantChunk(item.content);
                    if (choices.status === 2){
                        currentAssistantEl = null; currentReasoningEl = null;
                    }
                }
            } catch (e) { console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e, event.data); }
        };
        ws.onclose = () => { connected = false; connecting = false; setStatus('å·²æ–­å¼€'); };
        ws.onerror = (e) => { console.error(e); setStatus('è¿æ¥å‡ºé”™'); connecting = false; };
    } catch (e) {
        console.error(e); connecting = false; setStatus('ç­¾åæˆ–è¿æ¥å¤±è´¥: ' + e.message);
    }
}

function setStatus(text){ document.getElementById('statusText').innerText = text; }

function sendMsg(){
    const input = document.getElementById('userInput');
    const content = input.value.trim();
    if (!content) return;
    input.value = '';
    appendUser(content);
    beginAssistant();
    if (!connected){ pendingToSend = content; ensureConnected(); return; }
    _send(content);
}

function _send(content){
    if (!ws) return;
    const body = {
        header: { uid: 'demo_user', app_id: appId, protocol_type: 'spark' },
        payload: { message: { text: [{ role: 'user', content }] } },
        parameter: { chat: { domain: 'x1', max_tokens: 2048, temperature: 0.5, top_k: 5, presence_penalty: 1.0, frequency_penalty: 0.02, tools: [] } }
    };
    try { ws.send(JSON.stringify(body)); } catch(e){ console.error(e); setStatus('å‘é€å¤±è´¥: ' + e.message); }
}

window.addEventListener('DOMContentLoaded', () => { ensureConnected(); });
</script>
</body>
</html>